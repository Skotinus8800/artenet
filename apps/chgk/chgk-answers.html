<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ЧГК | Проверка ответов</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .b-example-divider {
        width: 100%;
        height: 3rem;
        background-color: rgba(0, 0, 0, .1);
        border: solid rgba(0, 0, 0, .15);
        border-width: 1px 0;
        box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
      }

      .b-example-vr {
        flex-shrink: 0;
        width: 1.5rem;
        height: 100vh;
      }

      .bi {
        vertical-align: -.125em;
        fill: currentColor;
      }

      .nav-scroller {
        position: relative;
        z-index: 2;
        height: 2.75rem;
        overflow-y: hidden;
      }

      .nav-scroller .nav {
        display: flex;
        flex-wrap: nowrap;
        padding-bottom: 1rem;
        margin-top: -1px;
        overflow-x: auto;
        text-align: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      .btn-bd-primary {
        --bd-violet-bg: #712cf9;
        --bd-violet-rgb: 112.520718, 44.062154, 249.437846;

        --bs-btn-font-weight: 600;
        --bs-btn-color: var(--bs-white);
        --bs-btn-bg: var(--bd-violet-bg);
        --bs-btn-border-color: var(--bd-violet-bg);
        --bs-btn-hover-color: var(--bs-white);
        --bs-btn-hover-bg: #6528e0;
        --bs-btn-hover-border-color: #6528e0;
        --bs-btn-focus-shadow-rgb: var(--bd-violet-rgb);
        --bs-btn-active-color: var(--bs-btn-hover-color);
        --bs-btn-active-bg: #5a23c8;
        --bs-btn-active-border-color: #5a23c8;
      }

      .bd-mode-toggle {
        z-index: 1500;
      }

      .bd-mode-toggle .dropdown-menu .active .bi {
        display: block !important;
      }

      html, body {
        height: 100%;
        min-height: 100vh;
      }
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      main {
        flex: 1 0 auto;
        padding-top: 56px;
      }
      footer {
        flex-shrink: 0;
      }

      .black{
        color:rgba(0, 0, 0, 0.803);
        background-color: rgba(97, 97, 97, 0.325);
        border-radius: 10px;
      }

      #liveAlertPlaceholder {
        position: fixed;
        top: 70px; /* чуть ниже navbar */
        left: 0;
        right: 0;
        z-index: 2000;
        width: 100%;
        max-width: 500px;
        margin: 0 auto;
        pointer-events: none;
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      #liveAlertPlaceholder .alert {
        pointer-events: auto;
        margin-bottom: 0.5rem;
      }
    </style>
  </head>

  <body class="d-flex flex-column min-vh-100 p-0 m-0 border-0 bd-example">
    <nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="../chgk.html">
          <img src="../../photos/logo-color-2.png" alt="ARTEnet" height="30" class="d-inline-block align-text-top">
          <img src="../../photos/chgk-logo.jpg" alt="ЧГК" height="30" class="d-inline-block align-text-top">
          Что? Где? Когда?
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <small>
            <em>
              <span class="navbar-text m-2" id="user-id">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              </span>
            </em>
          </small>
        </div>
      </div>
    </nav>

    <div id="liveAlertPlaceholder" role="alert"></div>

    <div class="modal fade" id="noChgkModal" tabindex="-1" aria-labelledby="noChgkModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header border-0">
            <h5 class="modal-title w-100" id="noChgkModalLabel">Нет доступа</h5>
          </div>
          <div class="modal-body">
            <svg xmlns="http://www.w3.org/2000/svg" width="10rem" height="10rem" fill="currentColor" class="bi bi-emoji-astonished mb-2" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
              <path d="M7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5m4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5M4.884 4.022a2 2 0 0 1 1.458-.048.5.5 0 0 0 .316-.948 3 3 0 0 0-2.167.077 3.1 3.1 0 0 0-.773.478q-.036.03-.07.064l-.002.001a.5.5 0 0 0 .707.708l-.001.002.001-.002a2 2 0 0 1 .122-.1 2 2 0 0 1 .41-.232Zm6.232 0a2 2 0 0 0-1.458-.048.5.5 0 1 1-.316-.948 3 3 0 0 1 2.168.077 3 3 0 0 1 .773.478l.07.064v.001a.5.5 0 0 1-.706.708l.002.002-.002-.002a2 2 0 0 0-.122-.1 2 2 0 0 0-.41-.232ZM8 10c-.998 0-1.747.623-2.247 1.246-.383.478.08 1.06.687.98q1.56-.202 3.12 0c.606.08 1.07-.502.687-.98C9.747 10.623 8.998 10 8 10"/>
            </svg>
            <p class="mb-1 h5">У вас нет доступа этому к приложению.<br></p>
            <p class="mb-3 leaad"><i>Если считаете, что это ошибка, обратитесь в <a href="mailto:ltartenet@gmail.com">поддержку</a>.</i></p>
            <div class="progress mb-1" style="height: 0.5rem;">
              <div id="noChgkProgress" class="progress-bar bg-danger" role="progressbar" style="width: 0%; transition: width 10s linear;"></div>
            </div>
          </div>
          <div class="modal-footer justify-content-center border-0">
            <div class="w-100 px-3">
              <button type="button" class="btn btn-danger w-100 py-2" id="noAccessBtn">Вернуться назад</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="blockedModal" tabindex="-1" aria-labelledby="blockedModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header border-0">
            <h5 class="modal-title w-100" id="blockedModalLabel">Доступ заблокирован</h5>
          </div>
          <div class="modal-body">
            <svg xmlns="http://www.w3.org/2000/svg" width="10rem" height="10rem" fill="currentColor" class="bi bi-exclamation-triangle mb-2" viewBox="0 0 16 16">
              <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
              <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
            </svg>
            <p class="mb-1 h5">Ваш аккаунт заблокирован.<br></p>
            <p class="mb-3 leaad"><i>Обратитесь в <a href="mailto:ltartenet@gmail.com">поддержку</a> для выяснения причин.</i></p>
            <div class="progress" style="height: 0.5rem;">
              <div id="blockedProgress" class="progress-bar bg-danger" role="progressbar" style="width: 100%; transition: width 10s linear;"></div>
            </div>
          </div>
          <div class="modal-footer justify-content-center border-0">
            <div class="w-100 px-3">
              <button type="button" class="btn btn-danger w-100 py-2" id="blockedBackBtn">Выйти</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <main class="flex-grow-1 d-flex align-items-center justify-content-center">
      <div class="container py-4" id="chgk-main-container">
        <button class="btn btn-danger mb-3" id="openPenaltyModalBtn">Штрафовать игрока</button>
        <button class="btn btn-info mb-3 ms-2" id="openAppealsModalBtn">АППЕЛЯЦИИ</button>
        <div id="penaltyModalContainer"></div>
        <div id="appealsModalContainer"></div>
      </div>
    </main>
  
    <footer class="bg-body-tertiary text-center text-lg-start mt-4 border-top">
      <div class="container p-3">
        <div class="row align-items-center">
          <div class="col-lg-6 text-lg-start text-center mb-2 mb-lg-0">
            <span class="fw-bold">ARTEnet &copy; 2025</span>
          </div>
          <div class="col-lg-6 text-lg-end text-center">
            <a href="../../main.html" class="text-decoration-none text-secondary me-3">Главный экран</a>
            <a href="mailto:ltartenet@gmail.com" class="text-decoration-none text-secondary me-3">Поддержка</a>
            <a href="#" class="text-decoration-none text-secondary disabled">Политика конфиденциальности</a>
          </div>
        </div>
      </div>
    </footer>

  <!--    FIREBASE    -->
      
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, reload, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
    import { getDatabase, ref, get, set, remove, child, onValue } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBZkU-HmTgsFV7McrsDr-Q5WkEBxkA2SD0",
      authDomain: "artenetshop-7b884.firebaseapp.com",
      projectId: "artenetshop-7b884",
      storageBucket: "artenetshop-7b884.appspot.com",
      messagingSenderId: "542098227452",
      appId: "1:542098227452:web:ce14dfbbbd7ca0d34b5779",
      measurementId: "G-8PDLBR77YN",
      databaseURL: "https://artenetshop-7b884-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const analytics = getAnalytics(app);
    const user = sessionStorage.getItem('isLoggedIn');
    const db = getDatabase(app);

    const alertPlaceholder = document.getElementById('liveAlertPlaceholder');

    const appendAlert = (message, type) => {
      // Удалим лишние алерты, если их больше двух
      while (alertPlaceholder.children.length >= 2) {
        alertPlaceholder.removeChild(alertPlaceholder.firstChild);
      }

      const wrapper = document.createElement('div');
      wrapper.className = `alert alert-${type} alert-dismissible fade show`;
      wrapper.role = 'alert';
      wrapper.innerHTML = `
        <div>${message}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;

      alertPlaceholder.append(wrapper);

      // Удаление алерта через 10 секунд
      setTimeout(() => {
        wrapper.classList.remove("show"); // плавное исчезновение
        setTimeout(() => wrapper.remove(), 150); // удаление из DOM
      }, 10000);
    };


    onAuthStateChanged(auth, async (user) => {
      if (!user || !user.emailVerified) {
        window.location.href = "../index.html";
        return;
      }
      // Получаем данные пользователя
      const userDbRef = ref(db, `users/${user.uid}`);
      const userDbSnap = await get(userDbRef);
      const userData = userDbSnap.exists() ? userDbSnap.val() : {};
      const name = userData.username || "";
      const email = user.email || "";
      document.getElementById('user-id').textContent = name
        ? `${name} (${email})`
        : email;

      // Проверка на администратора
      if (!userData.isAdmin) {
        alert("Доступ только для администратора!");
        window.location.href = "../../main.html";
        return;
      }

      // Получаем gameId из URL
      const urlParams = new URLSearchParams(window.location.search);
      const gameId = urlParams.get('game');
      if (!gameId) {
        appendAlert("Не указан gameId!", "danger");
        return;
      }

      // Получаем данные игры для отображения времени
      const gameSnap = await get(ref(db, `apps/chgk/games/${gameId}`));
      let gameDateStr = "";
      if (gameSnap.exists()) {
        const game = gameSnap.val();
        if (game.startAt) {
          try {
            gameDateStr = new Date(game.startAt).toLocaleString(undefined, {
              dateStyle: "medium",
              timeStyle: "short"
            });
          } catch {
            gameDateStr = game.date || "";
          }
        } else {
          gameDateStr = game.date || "";
        }
      }

      // --- Автообновление и рендеринг таблицы туров ---
      let tours = {};
      let results = {};
      let users = {};
      let gameOpen = true; // статус всей игры

      const main = document.querySelector("main");
      const answersModalContainer = document.createElement('div');
      answersModalContainer.id = "answersModalContainer";
      // Очищаем и добавляем контейнер для модалок
      main.innerHTML = `<div class="container py-4" id="chgk-main-container"></div>`;
      document.getElementById('chgk-main-container').appendChild(answersModalContainer);

      // Функция рендера таблицы туров
      function renderToursTable() {
        const tourIds = Object.keys(tours);
        // Список uid участников (results)
        const allUserIds = Object.keys(results);
        // Для каждого тура считаем сколько ответили
        const tourAnswered = {};
        tourIds.forEach(tid => {
          let answered = 0;
          allUserIds.forEach(uid => {
            if (
              results[uid] &&
              results[uid][tid] &&
              Array.isArray(results[uid][tid].answers) &&
              results[uid][tid].answers.some(a => a !== undefined && a !== "")
            ) {
              answered++;
            }
          });
          tourAnswered[tid] = answered;
        });

        // Имя игры
        const gameName = tours && tours[tourIds[0]] && tours[tourIds[0]].gameName ? tours[tourIds[0]].gameName : "Проверка туров";
        // Количество участников (только те, кто есть в results)
        const totalPlayers = allUserIds.length;

        // Кнопка открытия/закрытия всей игры
        const gameStatusBtn = `
          <button id="toggleGameOpenBtn" class="btn btn-${gameOpen ? "danger" : "success"} mb-3">
            ${gameOpen ? "Закрыть доступ к игре для игроков" : "Открыть доступ к игре для игроков"}
          </button>
        `;

        // Кнопка управления видимостью кнопки аппеляций
        const appealsVisible = localStorage.getItem('chgk_appeals_enabled') === '1';
        const toggleAppealsBtn = `
          <button class="btn btn-outline-${appealsVisible ? 'danger' : 'success'} mb-3 ms-2" id="toggleAppealsBtn">
            ${appealsVisible ? 'Скрыть кнопку аппеляций у игроков' : 'Показать кнопку аппеляций у игроков'}
          </button>
        `;

        document.getElementById('chgk-main-container').innerHTML = `
          <h2 class="mb-4 text-center">${gameName}</h2>
          <div class="text-center text-secondary mb-2">${gameDateStr ? `Время игры: <b>${gameDateStr}</b>` : ""}</div>
          <div class="text-center">${gameStatusBtn}</div>
          <div class="mb-3 text-center">
            ${toggleAppealsBtn}
          </div>
          <div class="table-responsive">
            <table class="table table-bordered text-center align-middle shadow" style="background:#fff;border-radius:12px;overflow:hidden;">
              <thead class="table-dark">
                <tr>
                  <th>Название тура</th>
                  <th>Вопросов</th>
                  <th>Ответили</th>
                  <th>Статус</th>
                  <th>Действия</th>
                </tr>
              </thead>
              <tbody>
                ${tourIds.map(tid => {
                  const isOpen = tours[tid]?.open !== false;
                  const questionsCount = Array.isArray(tours[tid]?.questions) ? tours[tid].questions.length : 0;
                  const answered = tourAnswered[tid] || 0;
                  return `
                    <tr>
                      <td>${tours[tid]?.name || tid}</td>
                      <td>${questionsCount}</td>
                      <td>
                        <span class="badge bg-info text-dark">${answered} / ${totalPlayers}</span>
                      </td>
                      <td>
                        <span class="badge ${isOpen ? "bg-success" : "bg-secondary"}">${isOpen ? "Открыт" : "Закрыт"}</span>
                      </td>
                      <td>
                        <button class="btn btn-primary btn-sm" data-check-tour="${tid}">Проверить тур</button>
                        <button class="btn btn-outline-dark btn-sm ms-2" data-show-results="${tid}">Результаты</button>
                        <button class="btn btn-${isOpen ? "warning" : "success"} btn-sm ms-2" data-toggle-tour="${tid}">
                          ${isOpen ? "Закрыть приём" : "Открыть приём"}
                        </button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
          <div id="answersModalContainer"></div>
          <!-- Добавлено: Кнопка и контейнер для штрафов -->
          <button class="btn btn-danger mb-3" id="openPenaltyModalBtn">Штрафовать игрока</button>
          <button class="btn btn-info mb-3 ms-2" id="openAppealsModalBtn">АППЕЛЯЦИИ</button>
          <div id="penaltyModalContainer"></div>
          <div id="appealsModalContainer"></div>
        `;

        // Кнопка открыть/закрыть всю игру
        document.getElementById('toggleGameOpenBtn').onclick = async () => {
          await set(ref(db, `apps/chgk/games/${gameId}/open`), !gameOpen);
          appendAlert(`Доступ к игре теперь ${gameOpen ? "закрыт" : "открыт"} для игроков.`, gameOpen ? "warning" : "success");
        };

        // Обработчики кнопок
        document.querySelectorAll('[data-check-tour]').forEach(btn => {
          btn.onclick = () => openTourCheckModal(btn.dataset.checkTour);
        });
        document.querySelectorAll('[data-show-results]').forEach(btn => {
          btn.onclick = () => showResultsTable(btn.dataset.showResults);
        });
        document.querySelectorAll('[data-toggle-tour]').forEach(btn => {
          btn.onclick = async () => {
            const tid = btn.dataset.toggleTour;
            const isOpen = tours[tid]?.open !== false;
            await set(ref(db, `apps/chgk/games/${gameId}/tours/${tid}/open`), !isOpen);
            appendAlert(`Тур "${tours[tid]?.name || tid}" теперь ${isOpen ? "закрыт" : "открыт"} для приёма ответов.`, isOpen ? "warning" : "success");
            // location.reload(); // больше не нужно, автообновление
          };
        });

        // Кнопка скрыть/показать кнопку аппеляций у игроков
        // Проверяем, что элемент существует перед назначением обработчика
        const toggleAppealsBtnEl = document.getElementById('toggleAppealsBtn');
        if (toggleAppealsBtnEl) {
          toggleAppealsBtnEl.onclick = () => {
            const enabled = localStorage.getItem('chgk_appeals_enabled') === '1';
            if (enabled) {
              localStorage.setItem('chgk_appeals_enabled', '0');
              appendAlert("Кнопка аппеляций скрыта у игроков.", "warning");
            } else {
              localStorage.setItem('chgk_appeals_enabled', '1');
              appendAlert("Кнопка аппеляций теперь доступна игрокам!", "success");
            }
            renderToursTable();
          };
        }

        // Остальные обработчики кнопок также должны проверять существование элемента перед назначением
        const penaltyBtn = document.getElementById('openPenaltyModalBtn');
        if (penaltyBtn) penaltyBtn.onclick = openPenaltyModal;

        const appealsBtn = document.getElementById('openAppealsModalBtn');
        if (appealsBtn) appealsBtn.onclick = openAppealsModal;

        // Кнопка открыть аппеляции для игроков (устанавливает localStorage)
        document.getElementById('showAppealsBtn').onclick = () => {
          localStorage.setItem('chgk_appeals_enabled', '1');
          appendAlert("Кнопка аппеляций теперь доступна игрокам!", "success");
        };
      }

      // --- Автообновление данных ---
      const toursRef = ref(db, `apps/chgk/games/${gameId}/tours`);
      const resultsRef = ref(db, `apps/chgk/games/${gameId}/results`);
      const usersRef = ref(db, "users");
      const gameRef = ref(db, `apps/chgk/games/${gameId}`);

      onValue(toursRef, snap => {
        tours = snap.exists() ? snap.val() : {};
        renderToursTable();
      });
      onValue(resultsRef, snap => {
        results = snap.exists() ? snap.val() : {};
        renderToursTable();
      });
      onValue(usersRef, snap => {
        users = snap.exists() ? snap.val() : {};
      });
      // Следим за статусом всей игры
      onValue(gameRef, snap => {
        const val = snap.exists() ? snap.val() : {};
        gameOpen = (val.open !== false); // по умолчанию открыта
        renderToursTable();
      });

      if (userDbSnap.exists() && userDbSnap.val().blocked) {
        window.location.href = "../index.html";
        return;
      }

      // Функция результатов тура (вынесена на верхний уровень, чтобы была доступна везде)
      function showResultsTable(tourId) {
        const tour = tours[tourId];
        const questions = Array.isArray(tour?.questions) ? tour.questions : [];

        // Список всех участников
        const userList = Object.entries(results);

        // Формируем строки таблицы: по строкам игроки, по столбцам вопросы
        const rowsHtml = userList.map(([uid, userResults]) => {
          const points = userResults[tourId]?.points || {};
          const answers = userResults[tourId]?.answers || [];
          let total = 0;
          const cells = questions.map((q, qidx) => {
            const pts = typeof points[qidx] === "number" ? points[qidx] : 0;
            total += pts;
            // Для popover
            const answerText = answers[qidx] !== undefined && answers[qidx] !== "" ? answers[qidx] : "<i>нет ответа</i>";
            const correctText = q.answer ? q.answer : "<i>нет</i>";
            let popoverTitle = "";
            let popoverContent = "";
            if (pts === 1) {
              popoverTitle = "Ответ игрока";
              popoverContent = `<b>Ответ:</b> ${answerText}`;
            } else {
              popoverTitle = "Правильный и ответ игрока";
              popoverContent = `<b>Правильный ответ:</b> ${correctText}<br><b>Ответ игрока:</b> ${answerText}`;
            }
            const cellClass = pts === 1 ? "bg-success text-white" : "bg-danger text-white";
            return `<td class="fs-5 ${cellClass}">
              <span tabindex="0" class="cell-popover" 
                data-bs-toggle="popover" 
                data-bs-trigger="hover focus"
                data-bs-placement="top"
                data-bs-html="true"
                title="${popoverTitle}"
                data-bs-content="${popoverContent.replace(/"/g, '&quot;')}">
                ${pts === 1 ? "&#43;" : "&#8722;"}
              </span>
            </td>`;
          }).join('');
          return `
            <tr>
              <td>${users[uid]?.username || users[uid]?.email || uid}</td>
              ${cells}
              <td class="fw-bold">${total}</td>
            </tr>
          `;
        }).join('');

        // Заголовки: Вопрос 1, Вопрос 2, ... с popover
        const questionHeaders = questions.map((q, idx) =>
          `<th>
            <span tabindex="0" class="question-popover" 
              data-bs-toggle="popover" 
              data-bs-trigger="hover focus"
              data-bs-placement="top"
              data-bs-html="true"
              title="Вопрос ${idx + 1}"
              data-bs-content="<b>Вопрос:</b> ${q.question ? q.question.replace(/"/g, '&quot;') : ''}<br><b>Ответ:</b> ${q.answer ? q.answer.replace(/"/g, '&quot;') : ''}">
              ${idx + 1}
            </span>
          </th>`
        ).join('');

        let html = `
          <div class="modal fade" id="resultsModal" tabindex="-1" aria-labelledby="resultsModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl modal-dialog-centered">
              <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                  <h5 class="modal-title" id="resultsModalLabel">Результаты тура: ${tour.name || tourId}</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                </div>
                <div class="modal-body">
                  <div class="table-responsive">
                    <table class="table table-bordered text-center align-middle mb-0">
                      <thead>
                        <tr>
                          <th>Участник</th>
                          ${questionHeaders}
                          <th>Сумма</th>
                        </tr>
                      </thead>
                      <tbody>
                        ${rowsHtml}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        `;
        // Удаляем предыдущий модальный блок результатов, если он есть
        const oldModal = document.getElementById('resultsModal');
        if (oldModal) oldModal.remove();

        // Далее вставляем новый html
        document.getElementById('answersModalContainer').insertAdjacentHTML('beforeend', html);
        const modal = new bootstrap.Modal(document.getElementById('resultsModal'));
        modal.show();

        // Инициализация popover для всех .question-popover и .cell-popover
        setTimeout(() => {
          document.querySelectorAll('.question-popover, .cell-popover').forEach(el => {
            new bootstrap.Popover(el);
          });
        }, 200);
      }

      // Функция проверки тура
      async function openTourCheckModal(tourId) {
        const tour = tours[tourId];
        const questions = Array.isArray(tour?.questions) ? tour.questions : [];
        if (!questions.length) {
          appendAlert("В этом туре нет вопросов.", "warning");
          return;
        }

        // Собираем ответы всех участников по этому туру
        const answersByUser = {};
        Object.entries(results).forEach(([uid, userResults]) => {
          if (userResults[tourId] && Array.isArray(userResults[tourId].answers)) {
            answersByUser[uid] = userResults[tourId].answers;
          }
        });

        let currentQuestion = 0;
        let pointsByUser = {}; // uid -> { ...pointsByTourId }

        // Загружаем текущие баллы (если уже есть)
        Object.entries(results).forEach(([uid, userResults]) => {
          if (userResults[tourId] && typeof userResults[tourId].points === "object") {
            pointsByUser[uid] = { ...userResults[tourId].points };
          }
        });

        showQuestionModal();

        function showQuestionModal() {
          // Список ответов на текущий вопрос
          const questionObj = questions[currentQuestion] || {};
          const questionText = questionObj.question || `Вопрос ${currentQuestion + 1}`;
          const correctAnswer = questionObj.answer || "";
          let answersHtml = "";
          Object.entries(answersByUser).forEach(([uid, answers]) => {
            const answer = answers[currentQuestion] ?? "";
            const userName = users[uid]?.username || users[uid]?.email || uid;
            const currentPoints = (pointsByUser[uid]?.[currentQuestion] ?? 0);
            answersHtml += `
              <div class="d-flex align-items-center border rounded p-2 mb-2" data-uid="${uid}">
                <div class="flex-grow-1">
                  <b>${userName}</b><br>
                  <span class="text-secondary">${answer ? answer : "<i>Нет ответа</i>"}</span>
                </div>
                <div class="d-flex align-items-center gap-2 ms-3">
                  <button class="btn btn-outline-success btn-sm" data-plus="${uid}">+1</button>
                  <button class="btn btn-outline-danger btn-sm" data-minus="${uid}">0</button>
                  <span class="badge bg-light text-dark ms-2" id="points-${uid}">${currentPoints}</span>
                </div>
              </div>
            `;
          });

          const isLast = currentQuestion === questions.length - 1;

          const modalHtml = `
            <div class="modal fade" id="answersModal" tabindex="-1" aria-labelledby="answersModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="answersModalLabel">Вопрос ${currentQuestion + 1}: ${questionText}</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-3">
                      <span class="fw-bold">Правильный ответ:</span>
                      <span class="text-success">${correctAnswer || "<i>Не указан</i>"}</span>
                    </div>
                    ${answersHtml || '<div class="alert alert-secondary text-center">Нет ответов</div>'}
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                    <button type="button" class="btn btn-success" id="nextQuestionBtn">${isLast ? "Сохранить и закрыть" : "Далее"}</button>
                  </div>
                </div>
              </div>
            </div>
          `;

          document.getElementById('answersModalContainer').innerHTML = modalHtml;
          const modal = new bootstrap.Modal(document.getElementById('answersModal'));
          modal.show();

          // +1 балл
          document.querySelectorAll('[data-plus]').forEach(btn => {
            btn.onclick = () => {
              const uid = btn.dataset.plus;
              if (!pointsByUser[uid]) pointsByUser[uid] = {};
              pointsByUser[uid][currentQuestion] = 1;
              document.getElementById(`points-${uid}`).textContent = "1";
            };
          });
          // 0 баллов
          document.querySelectorAll('[data-minus]').forEach(btn => {
            btn.onclick = () => {
              const uid = btn.dataset.minus;
              if (!pointsByUser[uid]) pointsByUser[uid] = {};
              pointsByUser[uid][currentQuestion] = 0;
              document.getElementById(`points-${uid}`).textContent = "0";
            };
          });

          // Далее/Сохранить
          document.getElementById('nextQuestionBtn').onclick = async () => {
            // Сохраняем баллы за этот вопрос для всех
            await Promise.all(Object.entries(pointsByUser).map(async ([uid, ptsObj]) => {
              // Получаем актуальные баллы из базы
              const pointsRef = ref(db, `apps/chgk/games/${gameId}/results/${uid}/${tourId}/points`);
              let prevPoints = {};
              try {
                const snap = await get(pointsRef);
                if (snap.exists()) {
                  const val = snap.val();
                  // Исправление: если points - число, превращаем в объект
                  if (typeof val === "object" && val !== null) {
                    prevPoints = val;
                  } else if (typeof val === "number") {
                    prevPoints = {};
                    prevPoints[0] = val;
                  }
                }
              } catch {}
              // Обновляем только текущий вопрос, остальные сохраняем
              prevPoints[currentQuestion] = ptsObj[currentQuestion] ?? 0;
              await set(pointsRef, prevPoints);
            }));

            modal.hide();

            if (!isLast) {
              currentQuestion++;
              showQuestionModal();
            } else {
              appendAlert("Результаты тура сохранены!", "success");
            }
          };
        }
      }

      async function openPenaltyModal() {
        // Получаем игроков и туры
        const usersSnap = await get(ref(db, "users"));
        const usersObj = usersSnap.exists() ? usersSnap.val() : {};
        const gameSnap = await get(ref(db, `apps/chgk/games/${gameId}`));
        const toursSnap = await get(ref(db, `apps/chgk/games/${gameId}/tours`));
        const toursObj = toursSnap.exists() ? toursSnap.val() : {};

        // Список пользователей для селекта (добавляем email в label)
        const userOptions = Object.entries(usersObj)
          .map(([uid, u]) =>
            `<option value="${uid}" data-email="${u.email || ''}">${u.username || u.email || uid}${u.email ? ' (' + u.email + ')' : ''}</option>`
          ).join('');
        const tourOptions = Object.entries(toursObj)
          .map(([tid, t]) => `<option value="${tid}">${t.name || tid}</option>`)
          .join('');

        // Собираем все штрафы по игре
        const penaltiesSnap = await get(ref(db, `apps/chgk/games/${gameId}/penalties`));
        const penaltiesObj = penaltiesSnap.exists() ? penaltiesSnap.val() : {};

        // Список всех штрафов для просмотра и удаления
        let penaltiesListHtml = "";
        let hasPenalties = false;
        Object.entries(penaltiesObj).forEach(([uid, arr]) => {
          if (!Array.isArray(arr)) return;
          arr.forEach((pen, idx) => {
            hasPenalties = true;
            const user = usersObj[uid] || {};
            const tourName = toursObj[pen.tour]?.name || pen.tour;
            let value = "";
            if (pen.points) value = `-${pen.points}`;
            else if (pen.percent) value = `-${pen.percent}%`;
            penaltiesListHtml += `
              <tr>
                <td>${user.username || user.email || uid} <span class="text-secondary small">${user.email ? '('+user.email+')' : ''}</span></td>
                <td>${tourName}</td>
                <td>${value}</td>
                <td>${pen.reason || ""}</td>
                <td>
                  <button class="btn btn-outline-danger btn-sm" data-del-penalty="${uid}" data-del-idx="${idx}" title="Удалить штраф">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16">
                      <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5.5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6zm3 .5a.5.5 0 0 1 .5-.5.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6zm-7-1A1.5 1.5 0 0 1 5.5 4h5A1.5 1.5 0 0 1 12 5.5V6h1a.5.5 0 0 1 0 1h-1v7a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V7H3a.5.5 0 0 1 0-1h1v-.5zM5.5 5a.5.5 0 0 0-.5.5V6h6v-.5a.5.5 0 0 0-.5-.5h-5z"/>
                    </svg>
                  </button>
                </td>
              </tr>
            `;
          });
        });

        const html = `
          <div class="modal fade" id="penaltyModal" tabindex="-1" aria-labelledby="penaltyModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered modal-lg">
              <div class="modal-content">
                <form id="penaltyForm">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title" id="penaltyModalLabel">Выписать штраф игроку</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <div class="mb-2 d-flex align-items-center">
                      <div class="flex-grow-1">
                        <label class="form-label">Игрок</label>
                        <select class="form-select" name="player" id="penaltyPlayerSelect" required>
                          <option value="">Выберите игрока</option>
                          ${userOptions}
                        </select>
                      </div>
                      <div class="ms-3" id="penaltyPlayerEmail" style="min-width:180px;color:#888;font-size:0.95em;"></div>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Тур</label>
                      <select class="form-select" name="tour" required>
                        <option value="">Выберите тур</option>
                        ${tourOptions}
                      </select>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Причина</label>
                      <input type="text" class="form-control" name="reason" required placeholder="Причина штрафа">
                    </div>
                    <div class="mb-2">
                      <label class="form-label">Штраф</label>
                      <div class="input-group">
                        <input type="number" class="form-control" name="points" min="0" placeholder="Сколько баллов снять">
                        <span class="input-group-text">или</span>
                        <input type="number" class="form-control" name="percent" min="0" max="100" placeholder="% от баллов тура">
                        <span class="input-group-text">%</span>
                      </div>
                      <small class="text-secondary">Заполните только одно поле</small>
                    </div>
                    <hr>
                    <div>
                      <h6 class="mb-2">Все штрафы</h6>
                      <div class="table-responsive" style="max-height:220px;overflow:auto;">
                        <table class="table table-sm table-bordered align-middle mb-0">
                          <thead>
                            <tr>
                              <th>Игрок</th>
                              <th>Тур</th>
                              <th>Штраф</th>
                              <th>Причина</th>
                              <th></th>
                            </tr>
                          </thead>
                          <tbody>
                            ${hasPenalties ? penaltiesListHtml : `<tr><td colspan="5" class="text-center text-secondary">Нет штрафов</td></tr>`}
                          </tbody>
                        </table>
                      </div>
                    </div>
                  </div>
                  <div class="modal-footer">
                    <button class="btn btn-danger w-100" type="submit">Выписать штраф</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        `;
        document.getElementById('penaltyModalContainer').innerHTML = html;
        const modal = new bootstrap.Modal(document.getElementById('penaltyModal'));
        modal.show();

        // Показывать email выбранного пользователя (берём из users, а не только из data-email)
        const playerSelect = document.getElementById('penaltyPlayerSelect');
        const playerEmailDiv = document.getElementById('penaltyPlayerEmail');
        playerSelect.onchange = function() {
          const uid = playerSelect.value;
          const email = usersObj[uid]?.email || '';
          playerEmailDiv.textContent = email ? email : '';
        };
        // Инициализация email при открытии
        playerSelect.dispatchEvent(new Event('change'));

        // Удаление штрафа
        document.querySelectorAll('[data-del-penalty]').forEach(btn => {
          btn.onclick = async function() {
            const uid = btn.getAttribute('data-del-penalty');
            const idx = Number(btn.getAttribute('data-del-idx'));
            if (!uid || isNaN(idx)) return;
            const penaltyRef = ref(db, `apps/chgk/games/${gameId}/penalties/${uid}`);
            let arr = [];
            try {
              const snap = await get(penaltyRef);
              if (snap.exists()) arr = snap.val();
              if (!Array.isArray(arr)) arr = [];
            } catch {}
            arr.splice(idx, 1);
            await set(penaltyRef, arr);
            appendAlert("Штраф удалён", "success");
            modal.hide();
            openPenaltyModal();
          };
        });

        document.getElementById('penaltyForm').onsubmit = async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const player = fd.get('player');
          const tour = fd.get('tour');
          const reason = fd.get('reason');
          const points = Number(fd.get('points')) || 0;
          const percent = Number(fd.get('percent')) || 0;
          if (!player || !tour || !reason || (!points && !percent)) {
            appendAlert("Заполните все поля!", "danger");
            return;
          }
          // Сохраняем штраф в БД
          const penaltyRef = ref(db, `apps/chgk/games/${gameId}/penalties/${player}`);
          const penaltyObj = {
            tour,
            reason,
            points,
            percent,
            issuedAt: new Date().toISOString(),
            issuedBy: auth.currentUser.uid
          };
          // Можно хранить массив штрафов
          let prev = [];
          try {
            const snap = await get(penaltyRef);
            if (snap.exists()) prev = snap.val();
            if (!Array.isArray(prev)) prev = [];
          } catch {}
          prev.push(penaltyObj);
          await set(penaltyRef, prev);
          appendAlert("Штраф выписан!", "success");
          modal.hide();
          openPenaltyModal();
        };
      };

      async function openAppealsModal() {
        const appealsSnap = await get(ref(db, `apps/chgk/games/${gameId}/appeals`));
        let appeals = appealsSnap.exists() ? appealsSnap.val() : {};
        if (Array.isArray(appeals)) {
          const obj = {};
          appeals.forEach(a => { if (a && a.id) obj[a.id] = a; });
          appeals = obj;
        }
        const usersSnap = await get(ref(db, "users"));
        const usersObj = usersSnap.exists() ? usersSnap.val() : {};
        const toursSnap = await get(ref(db, `apps/chgk/games/${gameId}/tours`));
        const toursObj = toursSnap.exists() ? toursSnap.val() : {};

        // Показываем все аппеляции, сортируем по дате (новые сверху)
        const appealEntries = Object.entries(appeals).sort(([, a], [, b]) => (b.createdAt || '').localeCompare(a.createdAt || ''));

        // Формируем массив промисов для асинхронных деталей
        const appealItems = await Promise.all(appealEntries.map(async ([id, a], i) => {
          // Статус
          let status = a.status || "active";
          let statusText = "На рассмотрении";
          let statusClass = "bg-warning text-dark";
          if (status === "approved") { statusText = "Одобрено"; statusClass = "bg-success"; }
          else if (status === "rejected") { statusText = "Отклонено"; statusClass = "bg-danger"; }
          else if (status === "archived") { statusText = "Архив"; statusClass = "bg-secondary"; }
          // Дата
          let dateStr = "";
          if (a.createdAt) {
            try {
              dateStr = new Date(a.createdAt).toLocaleString("ru-RU", { dateStyle: "medium", timeStyle: "short" });
            } catch {}
          }
          // Детали
          let details = "";
          if (a.type === 'question') {
            const tour = toursObj[a.tour] || {};
            const tourName = tour.name || a.tour;
            const questions = Array.isArray(tour.questions) ? tour.questions : [];
            const q = typeof a.questionIdx === "number" ? questions[a.questionIdx] : null;
            // Получить ответ игрока
            let userAnswer = "";
            try {
              const userResultSnap = await get(ref(db, `apps/chgk/games/${gameId}/results/${a.uid}/${a.tour}`));
              if (userResultSnap.exists() && Array.isArray(userResultSnap.val().answers) && typeof a.questionIdx === "number") {
                userAnswer = userResultSnap.val().answers[a.questionIdx] || "";
              }
            } catch {}
            details = `
              <div class="mb-1"><b>Тип:</b> вопрос</div>
              <div class="mb-1"><b>Тур:</b> ${tourName}</div>
              <div class="mb-1"><b>Вопрос №:</b> ${typeof a.questionIdx === "number" ? (a.questionIdx + 1) : ""}</div>
              <div class="mb-1"><b>Текст вопроса:</b> ${q && q.question ? q.question : "<i>нет</i>"}</div>
              <div class="mb-1"><b>Правильный ответ:</b> ${q && q.answer ? q.answer : "<i>нет</i>"}</div>
              <div class="mb-1"><b>Ответ игрока:</b> ${userAnswer || "<i>нет</i>"}</div>
            `;
          } else if (a.type === 'penalty') {
            const tour = toursObj[a.tour] || {};
            const tourName = tour.name || a.tour;
            // Получаем штраф
            let penaltyInfo = "";
            try {
              const penaltiesSnap = await get(ref(db, `apps/chgk/games/${gameId}/penalties/${a.uid}`));
              const penaltiesArr = penaltiesSnap.exists() ? penaltiesSnap.val() : [];
              const pen = Array.isArray(penaltiesArr) ? penaltiesArr.find(p => p.tour === a.tour) : null;
              if (pen) {
                penaltyInfo = `
                  <div class="mb-1"><b>Штраф:</b> ${pen.points ? `-${pen.points} баллов` : (pen.percent ? `-${pen.percent}%` : "")}</div>
                  <div class="mb-1"><b>Причина штрафа:</b> ${pen.reason || ""}</div>
                  <div class="mb-1"><b>Дата штрафа:</b> ${pen.issuedAt ? new Date(pen.issuedAt).toLocaleString("ru-RU", { dateStyle: "medium", timeStyle: "short" }) : ""}</div>
                `;
              }
            } catch {}
            details = `
              <div class="mb-1"><b>Тип:</b> штраф</div>
              <div class="mb-1"><b>Тур:</b> ${tourName}</div>
              ${penaltyInfo}
            `;
          }
          // Комментарий администратора
          let adminComment = a.adminComment ? `<div class="mt-1"><b>Комментарий администратора:</b> <span class="text-info">${a.adminComment}</span></div>` : "";
          return `
            <li class="list-group-item">
              <div class="d-flex justify-content-between align-items-center mb-1">
                <span class="badge ${statusClass}">${statusText}</span>
                <span class="text-secondary small">${dateStr}</span>
              </div>
              <div><b>${usersObj[a.uid]?.username || a.uid}</b></div>
              ${details}
              <div><b>Комментарий игрока:</b> ${a.comment}</div>
              <div><b>ID аппеляции:</b> <code>${id}</code></div>
              ${adminComment}
              <div class="mt-2">
                <textarea class="form-control mb-2" placeholder="Комментарий к решению" id="adminComment${id}">${a.adminComment || ""}</textarea>
                <div class="btn-group" role="group">
                  <button class="btn btn-success btn-sm" onclick="handleAppeal('${id}','approved')">Одобрить</button>
                  <button class="btn btn-danger btn-sm" onclick="handleAppeal('${id}','rejected')">Отклонить</button>
                  <button class="btn btn-secondary btn-sm" onclick="handleAppeal('${id}','archived')">В архив</button>
                </div>
              </div>
            </li>
          `;
        }));

        let html = `
          <div class="modal fade" id="appealsModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
              <div class="modal-content">
                <div class="modal-header bg-info text-white">
                  <h5 class="modal-title">Аппеляции</h5>
                  <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <ul class="list-group">
                    ${appealItems.length === 0 ? `<li class="list-group-item text-center text-secondary">Нет аппеляций</li>` : appealItems.join('')}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        `;
        document.getElementById('appealsModalContainer').innerHTML = html;
        const modal = new bootstrap.Modal(document.getElementById('appealsModal'));
        modal.show();

        window.handleAppeal = async (id, action) => {
          const appeal = appeals[id];
          const adminComment = document.getElementById(`adminComment${id}`).value;
          // Обновляем статус и комментарий
          appeal.status = action;
          appeal.adminComment = adminComment;
          // Выполняем действие только если статус изменился
          if (action === 'approved') {
            // Удалить штраф или начислить балл
            if (appeal.type === 'penalty') {
              const penaltyRef = ref(db, `apps/chgk/games/${gameId}/penalties/${appeal.uid}`);
              let penalties = [];
              const snap = await get(penaltyRef);
              if (snap.exists()) penalties = snap.val();
              penalties = penalties.filter(p => p.tour !== appeal.tour);
              await set(penaltyRef, penalties);
            } else if (appeal.type === 'question' && typeof appeal.questionIdx === "number") {
              const pointsRef = ref(db, `apps/chgk/games/${gameId}/results/${appeal.uid}/${appeal.tour}/points`);
              let prevPoints = {};
              try {
                const snap = await get(pointsRef);
                if (snap.exists()) {
                  const val = snap.val();
                  if (typeof val === "object" && val !== null) prevPoints = val;
                  else if (typeof val === "number") { prevPoints = {}; prevPoints[0] = val; }
                }
              } catch {}
              prevPoints[appeal.questionIdx] = 1;
              await set(pointsRef, prevPoints);
            }
          }
          // Статус rejected — ничего не делаем, только статус и комментарий
          // Статус archived — просто архивируем

          // Сохраняем обновлённую аппеляцию
          await set(ref(db, `apps/chgk/games/${gameId}/appeals/${id}`), appeal);
          appendAlert("Решение по аппеляции сохранено.", "success");
          modal.hide();
        };
      };

    // Ниже — функция для генерации уникального id аппеляции (8-10 символов)
    function generateAppealId() {
      const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789';
      let id = '';
      for (let i = 0; i < 9; i++) id += chars.charAt(Math.floor(Math.random() * chars.length));
      return id;
    }

    // Пример добавления аппеляции (вызывайте из нужного места, например, из формы игрока):
    // const appealId = generateAppealId();
    // await set(ref(db, `apps/chgk/games/${gameId}/appeals/${appealId}`), { id: appealId, ...otherFields });
    });
    </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
</body>
</html>