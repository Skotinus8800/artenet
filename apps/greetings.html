<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ARTEnet | Поздравления</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4Q6Gf2aSP4eDXB8Miphtr37CMZZQ5oXLH2yaXMJ2w8e2ZtHTl7GptT4jmndRuHDT" crossorigin="anonymous">

    <style>
      .bd-placeholder-img {
        font-size: 1.125rem;
        text-anchor: middle;
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }

      @media (min-width: 768px) {
        .bd-placeholder-img-lg {
          font-size: 3.5rem;
        }
      }

      .b-example-divider {
        width: 100%;
        height: 3rem;
        background-color: rgba(0, 0, 0, .1);
        border: solid rgba(0, 0, 0, .15);
        border-width: 1px 0;
        box-shadow: inset 0 .5em 1.5em rgba(0, 0, 0, .1), inset 0 .125em .5em rgba(0, 0, 0, .15);
      }

      .b-example-vr {
        flex-shrink: 0;
        width: 1.5rem;
        height: 100vh;
      }

      .bi {
        vertical-align: -.125em;
        fill: currentColor;
      }

      .nav-scroller {
        position: relative;
        z-index: 2;
        height: 2.75rem;
        overflow-y: hidden;
      }

      .nav-scroller .nav {
        display: flex;
        flex-wrap: nowrap;
        padding-bottom: 1rem;
        margin-top: -1px;
        overflow-x: auto;
        text-align: center;
        white-space: nowrap;
        -webkit-overflow-scrolling: touch;
      }

      .btn-bd-primary {
        --bd-violet-bg: #712cf9;
        --bd-violet-rgb: 112.520718, 44.062154, 249.437846;

        --bs-btn-font-weight: 600;
        --bs-btn-color: var(--bs-white);
        --bs-btn-bg: var(--bd-violet-bg);
        --bs-btn-border-color: var(--bd-violet-bg);
        --bs-btn-hover-color: var(--bs-white);
        --bs-btn-hover-bg: #6528e0;
        --bs-btn-hover-border-color: #6528e0;
        --bs-btn-focus-shadow-rgb: var(--bd-violet-rgb);
        --bs-btn-active-color: var(--bs-btn-hover-color);
        --bs-btn-active-bg: #5a23c8;
        --bs-btn-active-border-color: #5a23c8;
      }

      .bd-mode-toggle {
        z-index: 1500;
      }

      .bd-mode-toggle .dropdown-menu .active .bi {
        display: block !important;
      }

      html, body {
        height: 100%;
        min-height: 100vh;
      }
      body {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
      }
      main {
        flex: 1 0 auto;
        padding-top: 56px;
      }
      footer {
        flex-shrink: 0;
      }

      .black{
        color:rgba(0, 0, 0, 0.803);
        background-color: rgba(97, 97, 97, 0.325);
        border-radius: 10px;
      }

      #liveAlertPlaceholder {
        position: fixed;
        left: 1rem;
        bottom: 1rem;
        top: auto;
        right: auto;
        margin: 0;
        z-index: 1080;
        max-width: 350px;
      }

      .table-fixed {
        table-layout: fixed;
        width: 100%;
      }
      .table-fixed th, .table-fixed td {
        width: 25%;
        word-break: break-word;
      }

      .lock-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1;
      }
      .lock-content {
        text-align: center;
        padding: 1rem;
      }
    </style>
  </head>

  <body class="d-flex flex-column min-vh-100 p-0 m-0 border-0 bd-example">
    <nav class="navbar fixed-top navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="../main.html">
          <img src="../photos/logo-color-2.png" alt="ARTEnet" height="30" class="d-inline-block align-text-top">
        </a>

        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
          <ul class="navbar-nav">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="../main.html">Выйти из приложения</a>
            </li>
          </ul>
          <small>
            <em>
              <span class="navbar-text m-2" id="user-id">
                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
              </span>
            </em>
          </small>
          <form class="d-flex" id="logout-form">
            <button class="btn btn-outline-success" type="submit">Выйти из аккаунта</button>
          </form>
        </div>
      </div>
    </nav>

    <div class="modal fade" id="blockedModal" tabindex="-1" aria-labelledby="blockedModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header border-0">
            <h5 class="modal-title w-100" id="blockedModalLabel">Доступ заблокирован</h5>
          </div>
          <div class="modal-body">
            <p class="mb-3">Ваш аккаунт заблокирован.<br>Обратитесь в поддержку для выяснения причин.</p>
            <div class="progress mb-2" style="height: 0.5rem;">
              <div id="blockedProgress" class="progress-bar bg-danger" role="progressbar" style="width: 100%; transition: width 10s linear;"></div>
            </div>
          </div>
          <div class="modal-footer justify-content-center border-0">
            <button type="button" class="btn btn-secondary" id="blockedBackBtn">Выйти</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Модалка подтверждения удаления поздравления -->
    <div class="modal fade" id="deleteGreetingModal" tabindex="-1" aria-labelledby="deleteGreetingModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header border-0">
            <h5 class="modal-title w-100" id="deleteGreetingModalLabel">Удалить поздравление?</h5>
          </div>
          <div class="modal-body">
            <p>Вы действительно хотите удалить это поздравление?</p>
          </div>
          <div class="modal-footer justify-content-center border-0">
            <button type="button" class="btn btn-danger" id="confirmDeleteGreetingBtn">Удалить</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          </div>
        </div>
      </div>
    </div>

    <div id="liveAlertPlaceholder" role="alert"></div>

    <div class="modal fade" id="noAppModal" tabindex="-1" aria-labelledby="noAppModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header border-0">
            <h5 class="modal-title w-100" id="noAppModalLabel">Нет доступа</h5>
          </div>
          <div class="modal-body">
            <svg xmlns="http://www.w3.org/2000/svg" width="10rem" height="10rem" fill="currentColor" class="bi bi-emoji-astonished mb-2" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
              <path d="M7 6.5C7 7.328 6.552 8 6 8s-1-.672-1-1.5S5.448 5 6 5s1 .672 1 1.5m4 0c0 .828-.448 1.5-1 1.5s-1-.672-1-1.5S9.448 5 10 5s1 .672 1 1.5M4.884 4.022a2 2 0 0 1 1.458-.048.5.5 0 0 0 .316-.948 3 3 0 0 0-2.167.077 3.1 3.1 0 0 0-.773.478q-.036.03-.07.064l-.002.001a.5.5 0 0 0 .707.708l-.001.002.001-.002a2 2 0 0 1 .122-.1 2 2 0 0 1 .41-.232Zm6.232 0a2 2 0 0 0-1.458-.048.5.5 0 1 1-.316-.948 3 3 0 0 1 2.168.077 3 3 0 0 1 .773.478l.07.064v.001a.5.5 0 0 1-.706.708l.002.002-.002-.002a2 2 0 0 0-.122-.1 2 2 0 0 0-.41-.232ZM8 10c-.998 0-1.747.623-2.247 1.246-.383.478.08 1.06.687.98q1.56-.202 3.12 0c.606.08 1.07-.502.687-.98C9.747 10.623 8.998 10 8 10"/>
            </svg>
            <p class="mb-1 h5">У вас нет доступа этому к приложению.<br></p>
            <p class="mb-3 leaad"><i>Если считаете, что это ошибка, обратитесь в <a href="mailto:ltartenet@gmail.com">поддержку</a>.</i></p>
            <div class="progress mb-1" style="height: 0.5rem;">
              <div id="noAppProgress" class="progress-bar bg-danger" role="progressbar" style="width: 0%; transition: width 10s linear;"></div>
            </div>
          </div>
          <div class="modal-footer justify-content-center border-0">
            <div class="w-100 px-3">
              <button type="button" class="btn btn-danger w-100 py-2" id="noAccessBtn">Вернуться назад</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="blockedModal" tabindex="-1" aria-labelledby="blockedModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center">
          <div class="modal-header border-0">
            <h5 class="modal-title w-100" id="blockedModalLabel">Доступ заблокирован</h5>
          </div>
          <div class="modal-body">
            <svg xmlns="http://www.w3.org/2000/svg" width="10rem" height="10rem" fill="currentColor" class="bi bi-exclamation-triangle mb-2" viewBox="0 0 16 16">
              <path d="M7.938 2.016A.13.13 0 0 1 8.002 2a.13.13 0 0 1 .063.016.15.15 0 0 1 .054.057l6.857 11.667c.036.06.035.124.002.183a.2.2 0 0 1-.054.06.1.1 0 0 1-.066.017H1.146a.1.1 0 0 1-.066-.017.2.2 0 0 1-.054-.06.18.18 0 0 1 .002-.183L7.884 2.073a.15.15 0 0 1 .054-.057m1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767z"/>
              <path d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0M7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0z"/>
            </svg>
            <p class="mb-1 h5">Ваш аккаунт заблокирован.<br></p>
            <p class="mb-3 leaad"><i>Обратитесь в <a href="mailto:ltartenet@gmail.com">поддержку</a> для выяснения причин.</i></p>
            <div class="progress" style="height: 0.5rem;">
              <div id="blockedProgress" class="progress-bar bg-danger" role="progressbar" style="width: 100%; transition: width 10s linear;"></div>
            </div>
          </div>
          <div class="modal-footer justify-content-center border-0">
            <div class="w-100 px-3">
              <button type="button" class="btn btn-danger w-100 py-2" id="blockedBackBtn">Выйти</button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Модалка создания поздравления -->
    <div class="modal fade" id="createGreetingModal" tabindex="-1" aria-labelledby="createGreetingModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="createGreetingForm">
          <div class="modal-header">
            <h5 class="modal-title" id="createGreetingModalLabel">Новое поздравление</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="accordion" id="greetingAccordion">
              <!-- Шаг 1 -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="step1Header">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#step1" aria-expanded="true" aria-controls="step1">
                    1. Название
                  </button>
                </h2>
                <div id="step1" class="accordion-collapse collapse show" aria-labelledby="step1Header" data-bs-parent="#greetingAccordion">
                  <div class="accordion-body">
                    <div class="input-group mb-3">
                      <span class="input-group-text" id="basic-addon1">Название: </span>
                      <input type="text" class="form-control" name="title" id="greetTitle" placeholder="Название открытки" required>
                    </div>
                    <div class="input-group mb-3">
                      <span class="input-group-text" id="basic-addon1">Для:</span>
                      <input type="text" class="form-control" name="to" id="greetTo" placeholder="Кому" required>
                    </div>
                    <div class="input-group mb-3">
                      <span class="input-group-text" id="basic-addon1">От:</span>
                      <input type="text" class="form-control" name="from" id="greetFrom" placeholder="От кого" required>
                    </div>
                    <!-- СЕЛЕКТ ВРЕМЕНИ ЖИЗНИ -->
                    <div class="mt-3 mb-3" id="lifetimeSelectWrapper"></div>
                    <!-- КНОПКА ДАЛЕЕ -->
                    <button type="button" class="btn btn-primary w-100" id="toStep2Btn" disabled>Далее</button>
                  </div>
                </div>
              </div>
              <!-- Шаг 2 -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="step2Header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step2" aria-expanded="false" aria-controls="step2" disabled>
                    2. Текст поздравления
                  </button>
                </h2>
                <div id="step2" class="accordion-collapse collapse" aria-labelledby="step2Header" data-bs-parent="#greetingAccordion">
                  <div class="accordion-body">
                    <textarea class="form-control" name="text" id="greetText" placeholder="Текст поздравления" rows="3" required></textarea>
                    <button type="button" class="btn btn-primary w-100" id="toStep3Btn" disabled>Далее</button>
                  </div>
                </div>
              </div>
              <!-- Шаг 3 -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="step3Header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#step3" aria-expanded="false" aria-controls="step3" disabled>
                    3. Дополнительные украшения
                  </button>
                </h2>
                <div id="step3" class="accordion-collapse collapse" aria-labelledby="step3Header" data-bs-parent="#greetingAccordion">
                  <div class="accordion-body">
                    <label for="greetingPhotoInput" class="btn btn-outline-secondary w-100 mb-2">
                      <span id="photoLabelText">Загрузить обложку поздравления</span>
                      <input type="file" class="form-control mb-2" name="photo" id="greetingPhotoInput" accept="image/*">
                    </label>

                    <!-- Фоновые карточки -->
                    <div class="position-relative mb-2">
                      <div id="bgCardSelect" class="d-flex flex-wrap gap-2">
                        <input type="hidden" name="bg" id="greetingBgSelect" value="">
                        <div class="bg-card border rounded p-1 text-center" data-bg="" style="width: 90px; cursor:pointer;">
                          <div class="rounded mb-1" style="height:48px; background: repeating-linear-gradient(135deg, #f8fafc 0 40px, #e0e7ff 40px 80px, #f8fafc 80px 120px), url('https://png.pngtree.com/thumb_back/fw800/background/20230527/pngtree-festive-confetti-and-streamers-on-transparent-background-image_2727277.jpg'); background-size: cover, 300px 300px;"></div>
                          <small>Стандарт</small>
                        </div>
                        <div class="bg-card border rounded p-1 text-center" data-bg="bg1.jpg" style="width: 90px; cursor:pointer;">
                          <div class="rounded mb-1" style="height:48px; background: url('greetings/bg1.jpg') center/cover;"></div>
                          <small>Фейерверк</small>
                        </div>
                        <div class="bg-card border rounded p-1 text-center" data-bg="bg2.jpg" style="width: 90px; cursor:pointer;">
                          <div class="rounded mb-1" style="height:48px; background: url('greetings/bg2.jpg') center/cover;"></div>
                          <small>Цветы</small>
                        </div>
                        <div class="bg-card border rounded p-1 text-center" data-bg="bg3.jpg" style="width: 90px; cursor:pointer;">
                          <div class="rounded mb-1" style="height:48px; background: url('greetings/bg3.jpg') center/cover;"></div>
                          <small>Праздник</small>
                        </div>
                      </div>
                      <div id="bgLockOverlay" class="lock-overlay d-none">
                        <div class="lock-content">
                          <svg width="36" height="36" fill="#dc3545" viewBox="0 0 16 16">
                            <path d="M8 1a3 3 0 0 0-3 3v3H4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2v-5a2 2 0 0 0-2-2h-1V4a3 3 0 0 0-3-3zm-2 3a2 2 0 1 1 4 0v3H6V4zm-2 5a1 1 0 0 1 1-1h8a1 1 0 0 1 1 1v5a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V9z"/>
                          </svg>
                          <div class="fw-bold text-danger mt-2">ТОЛЬКО С ПЛАНОМ PLUS</div>
                        </div>
                      </div>
                    </div>
                    <button type="submit" class="btn btn-success w-100" id="createGreetingFinalBtn" disabled>
                      <span id="createGreetingBtnSpinner" class="spinner-border spinner-border-sm me-2 d-none" role="status" aria-hidden="true"></span>
                      Создать
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Модалка редактирования поздравления -->
    <div class="modal fade" id="editGreetingModal" tabindex="-1" aria-labelledby="editGreetingModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <form class="modal-content" id="editGreetingForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editGreetingModalLabel">Редактировать поздравление</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
          </div>
          <div class="modal-body">
            <div class="accordion" id="editGreetingAccordion">
              <!-- Шаг 1 -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="editStep1Header">
                  <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#editStep1" aria-expanded="true" aria-controls="editStep1">
                    1. Кому и название
                  </button>
                </h2>
                <div id="editStep1" class="accordion-collapse collapse show" aria-labelledby="editStep1Header" data-bs-parent="#editGreetingAccordion">
                  <div class="accordion-body">
                    <div class="input-group mb-3">
                      <span class="input-group-text" id="basic-addon1">Для:</span>
                      <input type="text" class="form-control" name="to" placeholder="Кому" required>
                    </div>
                    <div class="input-group mb-1">
                      <span class="input-group-text" id="basic-addon1">Название: </span>
                      <input type="text" class="form-control" name="title" placeholder="Название открытки" required>
                    </div>
                  </div>
                </div>
              </div>
              <!-- Шаг 2 -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="editStep2Header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#editStep2" aria-expanded="false" aria-controls="editStep2">
                    2. Текст поздравления
                  </button>
                </h2>
                <div id="editStep2" class="accordion-collapse collapse" aria-labelledby="editStep2Header" data-bs-parent="#editGreetingAccordion">
                  <div class="accordion-body">
                    <textarea class="form-control mb-2" name="text" placeholder="Текст поздравления" rows="3" required></textarea>
                  </div>
                </div>
              </div>
              <!-- Шаг 3 -->
              <div class="accordion-item">
                <h2 class="accordion-header" id="editStep3Header">
                  <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#editStep3" aria-expanded="false" aria-controls="editStep3">
                    3. От кого
                  </button>
                </h2>
                <div id="editStep3" class="accordion-collapse collapse" aria-labelledby="editStep3Header" data-bs-parent="#editGreetingAccordion">
                  <div class="accordion-body">
                    <input type="text" class="form-control mb-2" name="from" placeholder="От кого" required>
                  </div>
                </div>
              </div>
              <!-- Дополнительные поля: фото и фон -->
              <div id="editPhotoBgFields" style="display:none;">
                <hr>
                <div class="mb-3">
                  <label for="editGreetingPhotoInput" class="form-label">Фото (заменить)</label>
                  <input type="file" class="form-control" id="editGreetingPhotoInput" name="photo" accept="image/*">
                </div>
                <div class="mb-3">
                  <label for="editGreetingBgSelect" class="form-label">Фон открытки</label>
                  <select class="form-select" id="editGreetingBgSelect" name="bg">
                    <option value="">Стандартный</option>
                    <option value="bg1.jpg">Фон 1</option>
                    <option value="bg2.jpg">Фон 2</option>
                    <option value="bg3.jpg">Фон 3</option>
                  </select>
                </div>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-success">Сохранить</button>
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
          </div>
        </form>
      </div>
    </div>

    <main class="flex-grow-1 d-flex align-items-start justify-content-center">
      <div class="container py-4">
        <h2 class="mb-4 text-center">Ваши поздравления</h2>
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap">
          <div class="d-flex align-items-center mb-2 mb-md-0">
            <span id="currentPlanLabel" class="me-2 fw-semibold">План:  <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span></span>
            <button class="btn btn-outline-info btn-sm me-2" id="showPlansBtn">Планы</button>
          </div>
          <button class="btn btn-success" id="createGreetingBtn" data-bs-toggle="modal" data-bs-target="#createGreetingModal">Создать новое поздравление</button>
        </div>
        <div id="greetingsList" class="list-group mb-4">
          <div class="text-center text-muted" id="greetingsLoading">Загрузка...</div>
        </div>
      </div>

      <div class="modal fade" id="openGreetingModal" tabindex="-1" aria-labelledby="openGreetingModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
          <div class="modal-content shadow">
            <div class="modal-header bg-primary text-white">
              <h5 class="modal-title" id="openGreetingModalLabel">Ссылка на поздравление</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
              <div class="input-group">
                <input type="text" class="form-control" id="greetingLinkInput" readonly>
                <button class="btn btn-outline-primary" id="copyGreetingLinkBtn" type="button">Скопировать</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Модалка сравнения планов -->
      <div class="modal fade" id="plansModal" tabindex="-1" aria-labelledby="plansModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="plansModalLabel">Планы <small class="text-body-secondary">ARTEnet | Поздравления</small></h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Закрыть"></button>
            </div>
            <div class="modal-body">
              <div id="currentPlanInfo" class="mb-3 fw-semibold"></div>
                <div class="table-responsive"> 
                    <table class="table text-center table-fixed"> 
                      <thead> 
                        <tr> 
                        <th style="width: 34%;"></th> 
                        <th style="width: 22%;"><span class="badge text-bg-secondary">Бесплатный</span></th> 
                        <th style="width: 22%;"><span class="badge text-bg-success">PRO</span></th> 
                        <th style="width: 22%;"><span class="badge text-bg-primary">PLUS</span></th> 
                      </tr> 
                    </thead> 
                    <tbody> 
                      <tr> 
                        <th scope="row" class="text-start">Открытка на 1 день</th> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                      </tr> 
                      <tr> 
                        <th scope="row" class="text-start">Открытка на 3 дня</th> 
                        <td></td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                      </tr> 
                    </tbody> 
                    <tbody> 
                      <tr> 
                        <th scope="row" class="text-start">Открытка на 5 дней</th> 
                        <td></td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                      </tr> 
                      <tr> 
                        <th scope="row" class="text-start">Открытка на 7 дней</th> 
                        <td></td> 
                        <td></td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                      </tr> 
                      <tr> 
                        <th scope="row" class="text-start">Открытка на неограниченное время</th> 
                        <td></td> 
                        <td></td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                      </tr> 
                      <tr> 
                        <th scope="row" class="text-start">Добавление картинки</th> 
                        <td></td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                      </tr> 
                      <tr> 
                        <th scope="row" class="text-start">Изменение фона</th> 
                        <td></td> 
                        <td></td> 
                        <td>
                          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-check-circle" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14m0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16"/>
                            <path d="m10.97 4.97-.02.022-3.473 4.425-2.093-2.094a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05"/>
                          </svg>
                        </td> 
                      </tr> 
                      <tr class="table-info"> 
                        <th scope="row" class="text-start h5 ">Цена</th> 
                        <td><h5>БЕСПЛАТНО</h5></td> 
                        <td><h5>ЗА РЕКЛАМУ</h5></td> 
                        <td>
                          <h4 class="card-title pricing-card-title">
                            1,99 <span class="text-body-secondary">Eur</span>
                            <small class="text-body-secondary fw-light">
                              /мес.
                            </small>
                          </h4>
                        </td> 
                      </tr> 
                    </tbody> 
                  </table> 
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  
    <footer class="bg-body-tertiary text-center text-lg-start mt-4 border-top">
      <div class="container p-3">
        <div class="row align-items-center">
          <div class="col-lg-6 text-lg-start text-center mb-2 mb-lg-0">
            <span class="fw-bold">ARTEnet &copy; 2025</span>
          </div>
          <div class="col-lg-6 text-lg-end text-center">
            <a href="mailto:ltartenet@gmail.com" class="text-decoration-none text-secondary me-3">Поддержка</a>
            <a href="#" class="text-decoration-none text-secondary disabled">Политика конфиденциальности</a>
          </div>
        </div>
      </div>
    </footer>

  <!--    FIREBASE    -->
      
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getAuth, reload, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-analytics.js";
    import { getDatabase, ref, get, set, remove } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBZkU-HmTgsFV7McrsDr-Q5WkEBxkA2SD0",
      authDomain: "artenetshop-7b884.firebaseapp.com",
      projectId: "artenetshop-7b884",
      storageBucket: "artenetshop-7b884.appspot.com",
      messagingSenderId: "542098227452",
      appId: "1:542098227452:web:ce14dfbbbd7ca0d34b5779",
      measurementId: "G-8PDLBR77YN",
      databaseURL: "https://artenetshop-7b884-default-rtdb.europe-west1.firebasedatabase.app"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const analytics = getAnalytics(app);
    const user = sessionStorage.getItem('isLoggedIn');
    const db = getDatabase(app);

    let currentUser = null;

    const alertPlaceholder = document.getElementById('liveAlertPlaceholder');

    const appendAlert = (message, type) => {
      // Удалим лишние алерты, если их больше двух
      while (alertPlaceholder.children.length >= 2) {
        alertPlaceholder.removeChild(alertPlaceholder.firstChild);
      }

      const wrapper = document.createElement('div');
      wrapper.className = `alert alert-${type} alert-dismissible fade show`;
      wrapper.role = 'alert';
      wrapper.innerHTML = `
        <div>${message}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;

      alertPlaceholder.append(wrapper);

      // Удаление алерта через 10 секунд
      setTimeout(() => {
        wrapper.classList.remove("show"); // плавное исчезновение
        setTimeout(() => wrapper.remove(), 150); // удаление из DOM
      }, 10000);
    };


    onAuthStateChanged(auth, async (user) => {
      if (!user || !user.emailVerified) {
        window.location.href = "../index.html";
        return;
      }
      currentUser = user;

      // Получаем данные пользователя
      const userDbRef = ref(db, `users/${user.uid}`);
      const userDbSnap = await get(userDbRef);
      const userData = userDbSnap.exists() ? userDbSnap.val() : {};
      const name = userData.username || "";
      const email = user.email || "";
      document.getElementById('user-id').textContent = name
        ? `${name} (${email})`
        : email;

      // 1. Проверка блокировки пользователя
      if (userDbSnap.exists() && userDbSnap.val().blocked) {
        const blockedModalEl = document.getElementById('blockedModal');
        const blockedModal = new bootstrap.Modal(blockedModalEl, { backdrop: 'static', keyboard: false });
        const progressBar = document.getElementById('blockedProgress');
        let timer;

        progressBar.classList.remove("bg-secondary", "bg-success", "bg-warning");
        progressBar.classList.add("bg-danger");
        progressBar.style.transition = "none";
        progressBar.style.width = "100%";
        setTimeout(() => {
          progressBar.style.transition = "width 10s linear";
          progressBar.style.width = "0%";
        }, 50);

        document.getElementById("blockedBackBtn").onclick = async () => {
          clearTimeout(timer);
          blockedModal.hide();
          await signOut(auth);
          window.location.href = "../index.html";
        };

        timer = setTimeout(async () => {
          blockedModal.hide();
          await signOut(auth);
          window.location.href = "../index.html";
        }, 10000);

        blockedModal.show();
        return;
      }

      // 2. Проверка доступа к приложению
      const apps = userDbSnap.exists() && userDbSnap.val().apps;
      if (!apps || apps.greetings !== true) {
        const modalEl = document.getElementById('noAppModal');
        const progressBar = document.getElementById('noAppProgress');
        const modal = new bootstrap.Modal(modalEl, { backdrop: 'static', keyboard: false });

        progressBar.style.transition = "none";
        progressBar.style.width = "0%";
        setTimeout(() => {
          progressBar.style.transition = "width 10s linear";
          progressBar.style.width = "100%";
        }, 200); // увеличьте задержку до 200 мс

        modal.show();

        setTimeout(() => {
          modal.hide();
          window.location.href = "../main.html";
        }, 10000);

        return;
      }

      // --- Получаем план пользователя ---
      const userPlanSnap = await get(ref(db, `apps/greetings/userData/${user.uid}/plan`));
      const userPlan = userPlanSnap.exists() ? userPlanSnap.val() : 0;

      // --- Централизованное управление возможностями плана ---
      const PLAN_FEATURES = {
        0: { // Free
          canPhoto: false,
          canBg: false,
          lifetimes: [1],
          name: "Free"
        },
        1: { // PRO
          canPhoto: true,
          canBg: false,
          lifetimes: [1, 3, 5],
          name: "PRO"
        },
        2: { // PLUS
          canPhoto: true,
          canBg: true,
          lifetimes: [1, 3, 5, 7, 0],
          name: "PLUS"
        }
      };
      const features = PLAN_FEATURES[userPlan] || PLAN_FEATURES[0];

      // --- Ограничения по плану для фото ---
      const photoLabel = document.querySelector('label[for="greetingPhotoInput"]');
      const photoInput = document.getElementById('greetingPhotoInput');
      const photoLabelText = document.getElementById('photoLabelText');
      if (!features.canPhoto) {
        photoInput.disabled = true;
        photoLabel.classList.add('disabled', 'opacity-50');
        photoLabel.title = "Добавлять фото можно только с планом PLUS";
        photoLabelText.textContent = "Фото доступно только на PLUS";
      } else {
        photoInput.disabled = false;
        photoLabel.classList.remove('disabled', 'opacity-50');
        photoLabel.title = "";
        photoLabelText.textContent = "Загрузить обложку поздравления";
      }

      // --- Ограничения по плану для выбора фона ---
      const bgCardSelect = document.getElementById('bgCardSelect');
      const bgLockOverlay = document.getElementById('bgLockOverlay');
      if (!features.canBg) {
        bgCardSelect.classList.add('opacity-50', 'pointer-events-none');
        if (bgLockOverlay) bgLockOverlay.classList.remove('d-none');
      } else {
        bgCardSelect.classList.remove('opacity-50', 'pointer-events-none');
        if (bgLockOverlay) bgLockOverlay.classList.add('d-none');
        // Разрешить выбор карточки
        bgCardSelect.querySelectorAll('.bg-card').forEach(card => {
          card.onclick = () => {
            bgCardSelect.querySelectorAll('.bg-card').forEach(c => c.classList.remove('border-primary', 'shadow'));
            card.classList.add('border-primary', 'shadow');
            document.getElementById('greetingBgSelect').value = card.getAttribute('data-bg');
          };
        });
      }

      // --- Определение текущего плана ---
      document.getElementById("currentPlanLabel").textContent = `План: ${features.name}`;

      // --- Кнопка "Планы" ---
      document.getElementById("showPlansBtn").onclick = () => {
        document.getElementById("currentPlanInfo").textContent = `Ваш текущий план: ${features.name}`;
        new bootstrap.Modal(document.getElementById("plansModal")).show();
      };

      // --- Lifetime options по плану ---
      const planLifetimeOptions = PLAN_FEATURES;
      const availableOptions = features.lifetimes.map(days => {
        let label = "";
        switch (days) {
          case 1: label = "1 день"; break;
          case 3: label = "3 дня"; break;
          case 5: label = "5 дней"; break;
          case 7: label = "7 дней"; break;
          case 0: label = "Никогда"; break;
          default: label = `${days} дн.`;
        }
        return { days, label };
      });

      // --- Модалка создания/редактирования поздравления: добавляем select ---
      const createGreetingModalBody = document.querySelector('#createGreetingModal .modal-body');
      if (createGreetingModalBody && !document.getElementById('greetingLifetime')) {
        const select = document.createElement('select');
        select.className = "form-select mb-2";
        select.name = "lifetime";
        select.id = "greetingLifetime";
        PLAN_FEATURES[2].lifetimes.forEach(optDays => {
          const option = document.createElement('option');
          let label = "";
          switch (optDays) {
            case 1: label = "1 день"; break;
            case 3: label = "3 дня"; break;
            case 5: label = "5 дней"; break;
            case 7: label = "7 дней"; break;
            case 0: label = "Никогда"; break;
            default: label = `${optDays} дн.`;
          }
          option.value = optDays;
          option.textContent = `Удалить через: ${label}`;
          if (!features.lifetimes.includes(optDays)) {
            option.disabled = true;
            if (PLAN_FEATURES[1].lifetimes.includes(optDays)) {
              option.textContent += " (только PRO)";
              option.setAttribute('data-popover', 'Для выбора этого срока нужен план PRO');
            } else {
              option.textContent += " (только PLUS)";
              option.setAttribute('data-popover', 'Для выбора этого срока нужен план PLUS');
            }
          }
          select.appendChild(option);
        });
        // Вставляем select только один раз!
        const lifetimeSelectWrapper = document.getElementById('lifetimeSelectWrapper');
        if (lifetimeSelectWrapper) {
          lifetimeSelectWrapper.innerHTML = '';
          lifetimeSelectWrapper.appendChild(select);
        }
        // --- Popover для disabled опций ---
        select.addEventListener('change', function (e) {
          const selected = select.selectedOptions[0];
          if (selected.disabled && selected.hasAttribute('data-popover')) {
            appendAlert(selected.getAttribute('data-popover'), "warning");
            select.selectedIndex = 0;
          }
        });

        // --- Accessibility fix for modals (aria-hidden/inert) ---
        function fixModalAriaHidden(modalEl) {
          // Remove aria-hidden if present
          if (modalEl.hasAttribute('aria-hidden')) {
            modalEl.removeAttribute('aria-hidden');
          }
          // Remove inert if present
          if (modalEl.hasAttribute('inert')) {
            modalEl.removeAttribute('inert');
          }
        }
        // Patch all modals on show
        document.querySelectorAll('.modal').forEach(modalEl => {
          modalEl.addEventListener('show.bs.modal', () => {
            fixModalAriaHidden(modalEl);
          });
          // On hide, blur any focused element inside and set inert
          modalEl.addEventListener('hide.bs.modal', () => {
            if (modalEl.contains(document.activeElement)) {
              document.activeElement.blur();
            }
            modalEl.setAttribute('inert', '');
          });
        });
      }

      // --- Загрузка поздравлений пользователя ---
      const greetingsList = document.getElementById("greetingsList");
      const greetingsLoading = document.getElementById("greetingsLoading");
      greetingsLoading && (greetingsLoading.style.display = "block");
      greetingsList && (greetingsList.innerHTML = '<div class="text-center text-muted" id="greetingsLoading">Загрузка...</div>');

      const greetingsRef = ref(db, `apps/greetings/userData/${user.uid}/greetings`);
      const greetingsSnap = await get(greetingsRef);
      greetingsList.innerHTML = "";
      const now = Date.now();
      if (greetingsSnap.exists()) {
        const greetings = greetingsSnap.val();
        let hasGreetings = false;
        for (const [greetId, greet] of Object.entries(greetings)) {
          // Определяем lifetime (в днях) для поздравления
          let lifetimeDays = 3; // по умолчанию
          if (typeof greet.lifetime === "number") {
            lifetimeDays = greet.lifetime;
          } else if (availableOptions.length > 0) {
            lifetimeDays = availableOptions[0].days;
          }
          const lifetimeMs = lifetimeDays > 0 ? lifetimeDays * 24 * 60 * 60 * 1000 : 0;
          const createdAt = greet.createdAt || 0;
          const expiresAt = lifetimeMs > 0 ? createdAt + lifetimeMs : null;
          const timeLeft = expiresAt ? expiresAt - now : null;

          // Удаляем поздравления и фото, если срок истёк (кроме "никогда")
          if (lifetimeMs > 0 && expiresAt && now > expiresAt) {
            // Удалить фото, если есть
            if (greet.photoUrl) {
              try {
                await fetch('/apps/greetings/delete-photo.php', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ url: greet.photoUrl })
                });
              } catch (e) {
                // Ошибку можно игнорировать
              }
            }
            await remove(ref(db, `apps/greetings/userData/${user.uid}/greetings/${greetId}`));
            continue;
          }

          hasGreetings = true;
          const item = document.createElement("div");
          item.className = "list-group-item list-group-item-action d-flex flex-column align-items-stretch mb-2";

          // Верхняя часть (заголовок и кнопки)
          const topRow = document.createElement("div");
          topRow.className = "d-flex justify-content-between align-items-center w-100";
          topRow.innerHTML = `
            <div>
              <b>${greet.title || "Без названия"}</b>
              <div class="text-secondary small">${greet.createdAt ? new Date(greet.createdAt).toLocaleString() : ""}</div>
            </div>
            <div>
              <button class="btn btn-outline-primary btn-sm me-2 open-greeting-btn" data-greet-id="${greetId}">Открыть</button>
              <button class="btn btn-outline-warning btn-sm edit-greeting-btn me-2" data-greet-id="${greetId}">Изменить</button>
              <button class="btn btn-outline-danger btn-sm delete-greeting-btn" data-greet-id="${greetId}">Удалить</button>
            </div>
          `;
          item.appendChild(topRow);

          // Нижняя часть (таймер)
          const timerRow = document.createElement("div");
          timerRow.className = "w-100 mt-2";
          if (lifetimeMs > 0 && expiresAt) {
            // Прогресс-бар времени жизни
            const percent = Math.max(0, Math.min(100, Math.round(100 * (expiresAt - now) / lifetimeMs)));
            timerRow.innerHTML = `
              <div class="progress" style="height: 0.5rem;">
                <div class="progress-bar bg-info" role="progressbar" style="width: ${percent}%; transition: width 1s linear;"></div>
              </div>
              <div class="small text-end text-secondary mt-1" id="timer-${greetId}">
                Осталось: <span>${formatTimeLeft(timeLeft)}</span>
              </div>
            `;
          } else {
            timerRow.innerHTML = `<div class="small text-end text-success">Срок хранения: бессрочно</div>`;
          }
          item.appendChild(timerRow);

          greetingsList.appendChild(item);

          // Таймер обновления полосы и времени
          if (lifetimeMs > 0 && expiresAt) {
            const timerSpan = item.querySelector(`#timer-${greetId} span`);
            const progressBar = item.querySelector(".progress-bar");
            let interval = setInterval(() => {
              const now2 = Date.now();
              const left = expiresAt - now2;
              if (left <= 0) {
                clearInterval(interval);
                item.remove();
              } else {
                if (timerSpan) timerSpan.textContent = formatTimeLeft(left);
                if (progressBar) progressBar.style.width = Math.max(0, Math.min(100, Math.round(100 * (expiresAt - now2) / lifetimeMs))) + "%";
              }
            }, 1000);
          }
        }
        if (!hasGreetings) {
          greetingsList.innerHTML = '<div class="text-center text-muted">Поздравлений пока нет</div>';
        }
      } else {
        greetingsList.innerHTML = '<div class="text-center text-muted">Поздравлений пока нет</div>';
      }

      // --- Функция форматирования времени ---
      function formatTimeLeft(ms) {
        if (ms <= 0) return "0 сек.";
        const d = Math.floor(ms / (24 * 60 * 60 * 1000));
        const h = Math.floor((ms % (24 * 60 * 60 * 1000)) / (60 * 60 * 1000));
        const m = Math.floor((ms % (60 * 60 * 1000)) / (60 * 1000));
        const s = Math.floor((ms % (60 * 1000)) / 1000);
        let str = "";
        if (d > 0) str += `${d} д. `;
        if (h > 0) str += `${h} ч. `;
        if (m > 0) str += `${m} мин. `;
        if (s > 0) str += `${s} сек.`;
        return str.trim();
      }

      // Кнопки "Открыть" для поздравлений
      greetingsList.addEventListener("click", (e) => {
        const btn = e.target.closest(".open-greeting-btn");
        if (!btn) return;
        const greetId = btn.getAttribute("data-greet-id");
        const link = `${window.location.origin}/apps/greetings/greeting-card.html?id=${greetId}`;
        document.getElementById("greetingLinkInput").value = link;
        new bootstrap.Modal(document.getElementById("openGreetingModal")).show();
      });
      document.getElementById("copyGreetingLinkBtn").onclick = () => {
        const input = document.getElementById("greetingLinkInput");
        input.select();
        document.execCommand("copy");
        input.blur();
        appendAlert("Ссылка скопирована!", "success");
      };

      // Кнопка "Изменить поздравение"
      greetingsList.addEventListener("click", async (e) => {
        const btn = e.target.closest(".edit-greeting-btn");
        if (!btn) return;
        const greetId = btn.getAttribute("data-greet-id");
        const greetRef = ref(db, `apps/greetings/userData/${user.uid}/greetings/${greetId}`);
        const greetSnap = await get(greetRef);
        if (!greetSnap.exists()) {
          appendAlert("Поздравление не найдено", "danger");
          return;
        }
        const greet = greetSnap.val();
        // Заполняем форму модалки редактирования
        const modal = new bootstrap.Modal(document.getElementById("editGreetingModal"));
        const form = document.getElementById("editGreetingForm");
        form.to.value = greet.to || "";
        form.title.value = greet.title || "";
        form.text.value = greet.text || "";
        form.from.value = greet.from || "";
        form.setAttribute("data-edit-id", greetId);
        // Открыть все разделы аккордеона
        document.getElementById('editStep1').classList.add('show');
        //document.getElementById('editStep2').classList.add('show');
        //document.getElementById('editStep3').classList.add('show');
        document.querySelector('#editStep1Header .accordion-button').disabled = false;
        document.querySelector('#editStep2Header .accordion-button').disabled = false;
        document.querySelector('#editStep3Header .accordion-button').disabled = false;
        modal.show();
      });

      document.getElementById("confirmDeleteGreetingBtn").onclick = async () => {
        if (!currentUser || !greetingToDeleteId) return;
        // Получаем поздравление для проверки photoUrl
        const greetRef = ref(db, `apps/greetings/userData/${currentUser.uid}/greetings/${greetingToDeleteId}`);
        const greetSnap = await get(greetRef);
        if (greetSnap.exists()) {
          const greet = greetSnap.val();
          if (greet.photoUrl) {
            // Удаляем фото через PHP-скрипт
            await fetch('/apps/greetings/delete-photo.php', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ url: greet.photoUrl })
            });
          }
        }
        await remove(greetRef);
        greetingToDeleteId = null;
        bootstrap.Modal.getInstance(document.getElementById("deleteGreetingModal")).hide();
        appendAlert("Поздравление удалено", "info");
        location.reload();
      };

      // --- Управление аккордеоном создания поздравления ---

      // 1. Сброс и начальное состояние при открытии модалки
      document.getElementById('createGreetingBtn').addEventListener('click', () => {
        // Сбросить все поля
        document.getElementById('greetTo').value = '';
        document.getElementById('greetTitle').value = '';
        document.getElementById('greetText').value = '';
        document.getElementById('greetFrom').value = '';
        document.getElementById('greetingPhotoInput').value = '';
        document.getElementById('greetingBgSelect').value = '';

        // Сбросить классы show/collapsed для всех шагов
        document.getElementById('step1').classList.add('show');
        document.querySelector('#step1Header .accordion-button').classList.remove('collapsed');
        document.getElementById('step2').classList.remove('show');
        document.querySelector('#step2Header .accordion-button').classList.add('collapsed');
        document.getElementById('step3').classList.remove('show');
        document.querySelector('#step3Header .accordion-button').classList.add('collapsed');

        // Заблокировать кнопки перехода и шаги 2, 3
        document.getElementById('toStep2Btn').disabled = true;
        document.getElementById('toStep3Btn').disabled = true;
        document.getElementById('createGreetingFinalBtn').disabled = true;
        document.querySelector('#step2Header .accordion-button').disabled = true;
        document.querySelector('#step3Header .accordion-button').disabled = true;
      });

      // 2. Валидация и переходы между шагами
      function checkStep1() {
        const to = document.getElementById('greetTo').value.trim();
        const title = document.getElementById('greetTitle').value.trim();
        document.getElementById('toStep2Btn').disabled = !(to && title);
      }
      document.getElementById('greetTo').addEventListener('input', checkStep1);
      document.getElementById('greetTitle').addEventListener('input', checkStep1);

      document.getElementById('toStep2Btn').onclick = () => {
        // Открыть шаг 2, разблокировать его кнопку
        new bootstrap.Collapse(document.getElementById('step2'), { show: true });
        document.querySelector('#step2Header .accordion-button').disabled = false;
        document.querySelector('#step2Header .accordion-button').click();
        // Заблокировать шаг 3
        document.querySelector('#step3Header .accordion-button').disabled = true;
      };

      function checkStep2() {
        const text = document.getElementById('greetText').value.trim();
        document.getElementById('toStep3Btn').disabled = !text;
      }
      document.getElementById('greetText').addEventListener('input', checkStep2);

      document.getElementById('toStep3Btn').onclick = () => {
        // Открыть шаг 3, разблокировать его кнопку
        new bootstrap.Collapse(document.getElementById('step3'), { show: true });
        document.querySelector('#step3Header .accordion-button').disabled = false;
        document.querySelector('#step3Header .accordion-button').click();
      };

      function checkStep3() {
        const from = document.getElementById('greetFrom').value.trim();
        document.getElementById('createGreetingFinalBtn').disabled = !from;
      }
      document.getElementById('greetFrom').addEventListener('input', checkStep3);

      // 3. Блокируем ручное открытие шагов до заполнения предыдущих
      document.querySelector('#step2Header .accordion-button').addEventListener('click', (e) => {
        if (document.getElementById('toStep2Btn').disabled) e.preventDefault();
      });
      document.querySelector('#step3Header .accordion-button').addEventListener('click', (e) => {
        if (document.getElementById('toStep3Btn').disabled) e.preventDefault();
      });

      const createGreetingModal = document.getElementById('createGreetingModal');
createGreetingModal.addEventListener('hidden.bs.modal', () => {
  // Сбросить все поля
  document.getElementById('greetTo').value = '';
  document.getElementById('greetTitle').value = '';
  document.getElementById('greetText').value = '';
  document.getElementById('greetFrom').value = '';
  document.getElementById('greetingPhotoInput').value = '';
  document.getElementById('greetingBgSelect').value = '';
  document.getElementById('toStep2Btn').disabled = true;
  document.getElementById('toStep3Btn').disabled = true;
  document.getElementById('createGreetingFinalBtn').disabled = true;
  document.querySelector('#step2Header .accordion-button').disabled = true;
  document.querySelector('#step3Header .accordion-button').disabled = true;
  // Открыть только первый шаг
  new bootstrap.Collapse(document.getElementById('step1'), { show: true });
  new bootstrap.Collapse(document.getElementById('step2'), { hide: true });
  new bootstrap.Collapse(document.getElementById('step3'), { hide: true });
});
    });

    document.getElementById("logout-form").addEventListener("submit", (e) => {
      e.preventDefault();
      signOut(auth)
        .then(() => {
          window.location.href = "../index.html";
        })
        .catch((error) => {
          appendAlert("Ошибка выхода: " + error.message, "danger");
        });
    });

    // Обработка отправки формы создания/редактирования поздравления
    document.getElementById("createGreetingForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const form = e.target;
      const createBtn = document.getElementById('createGreetingFinalBtn');
      const spinner = document.getElementById('createGreetingBtnSpinner');
      // Блокируем все поля и показываем спиннер
      Array.from(form.elements).forEach(el => el.disabled = true);
      createBtn.disabled = true;
      if (spinner) spinner.classList.remove('d-none');
      createBtn.classList.add('disabled');

      try {
        const to = form.to.value.trim();
        const title = form.title.value.trim();
        const text = form.text.value.trim();
        const from = form.from.value.trim();
        const lifetime = parseInt(form.lifetime?.value || availableOptions[0].days, 10);
        const bg = form.bg?.value || "";

        if (!to || !title || !text || !from) {
          appendAlert("Пожалуйста, заполните все поля", "warning");
          return;
        }

        if (!currentUser) {
          appendAlert("Ошибка: пользователь не найден", "danger");
          return;
        }

        let greetId = form.getAttribute("data-edit-id");
        let createdAt = Date.now();
        if (greetId) {
          const oldSnap = await get(ref(db, `apps/greetings/userData/${currentUser.uid}/greetings/${greetId}`));
          if (oldSnap.exists() && oldSnap.val().createdAt) {
            createdAt = oldSnap.val().createdAt;
          }
        } else {
          greetId = Date.now();
        }

        const photoInput = document.getElementById('greetingPhotoInput');
        let photoUrl = "";
        if (photoInput && photoInput.files.length > 0) {
          const formData = new FormData();
          formData.append('photo', photoInput.files[0]);
          const resp = await fetch('/apps/greetings/upload-photo.php', {
            method: 'POST',
            body: formData
          });
          const data = await resp.json();
          if (data.url) {
            photoUrl = data.url;
          } else {
            appendAlert(data.error || "Ошибка загрузки фото", "danger");
            return;
          }
        }

        const newGreetingData = {
          id: greetId,
          to,
          title,
          text,
          from,
          createdAt,
          lifetime,
          photoUrl,
          bg
        };

        await set(ref(db, `apps/greetings/userData/${currentUser.uid}/greetings/${greetId}`), newGreetingData);

        appendAlert(greetId == Date.now() ? "Поздравление успешно создано" : "Поздравление изменено", "success");
        const modal = bootstrap.Modal.getInstance(document.getElementById('createGreetingModal'));
        modal.hide();
        form.reset();
        form.removeAttribute("data-edit-id");
        location.reload();
      } finally {
        // Разблокируем поля и убираем спиннер (если не было location.reload)
        if (spinner) spinner.classList.add('d-none');
        createBtn.classList.remove('disabled');
        Array.from(form.elements).forEach(el => el.disabled = false);
      }
    });

    // --- Кнопка "Удалить поздравление" (только через модалку!) ---
    let greetingToDeleteId = null;
    greetingsList.addEventListener("click", (e) => {
      const btn = e.target.closest(".delete-greeting-btn");
      if (!btn) return;
      greetingToDeleteId = btn.getAttribute("data-greet-id");
      new bootstrap.Modal(document.getElementById("deleteGreetingModal")).show();
    });

    // --- Показать модалку с планами ---
    document.getElementById("showPlansBtn").onclick = async () => {
      // Проверка на существование currentUser
      if (!currentUser) {
        appendAlert("Ошибка: пользователь не найден", "danger");
        return;
      }
      // Получаем элемент модалки
      const plansModalEl = document.getElementById("plansModal");
      if (!plansModalEl) {
        appendAlert("Ошибка: не найдена модалка планов", "danger");
        return;
      }
      // Проверяем, не открыта ли уже модалка
      if (plansModalEl.classList.contains('show')) return;
      // Создаём модалку с явным указанием backdrop
      const modal = new bootstrap.Modal(plansModalEl, { backdrop: true });
      modal.show();

      // Получаем текущий план пользователя
      if (!currentUser || !currentUser.uid) {
        appendAlert("Ошибка: пользователь не найден", "danger");
        return;
      }
      const userPlanSnap = await get(ref(db, `apps/greetings/userData/${currentUser.uid}/plan`));
      const userPlan = userPlanSnap.exists() ? userPlanSnap.val() : 0;

      // Обновляем информацию о текущем плане в модалке
      const currentPlanInfo = document.getElementById("currentPlanInfo");
      currentPlanInfo.textContent = `Ваш текущий план: ${userPlan === 0 ? "Free" : userPlan === 1 ? "PRO" : "PLUS"}`;

      // Заполняем таблицу планов
      const plansTableBody = document.querySelector("#plansModal table tbody");
      plansTableBody.innerHTML = `
        <tr>
          <td>Время хранения поздравления</td>
          <td>1 день</td>
          <td>1, 3, 5 дней</td>
          <td>1, 3, 5, 7 дней, никогда</td>
        </tr>
        <tr>
          <td>Стоимость</td>
          <td>Бесплатно</td>
          <td>Платно</td>
          <td>Платно</td>
        </tr>
      `;
    };
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js" integrity="sha384-j1CDi7MgGQ12Z7Qab0qlWQ/Qqz24Gc6BM0thvEMVjHnfYGF0rmFCozFSxQBxwHKO" crossorigin="anonymous"></script>
</body>
</html>